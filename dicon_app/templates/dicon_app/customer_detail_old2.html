{% extends 'dicon_app/base.html' %}
{% block title %}{{ customer.company_name }} の詳細{% endblock %}

<!-- {% block content %}
<h3 class="mt-4">商談履歴</h3>

<div class="card mb-3 bg-light">
    <div class="card-body">
        <h6 class="card-title">商談をクイック追加</h6>
        <form id="activity-form">
            {% csrf_token %}
            <input type="hidden" name="customer_id" value="{{ customer.id }}">

            <div class="row g-2">
                <div class="col-md-3">
                    <input type="date" name="activity_date" class="form-control" required>
                </div>
                <div class="col-md-3">
                    <select name="status" class="form-select">
                        <option value="APPO">アポ</option>
                        <option value="MEETING">商談中</option>
                        <option value="PROPOSAL">提案中</option>
                        <option value="WON">受注</option>
                        <option value="LOST">失注</option>
                    </select>
                </div>
                <div class="col-md-4">
                    <input type="text" name="note" class="form-control" placeholder="メモを入力" required>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-primary w-100">追加</button>
                </div>
            </div>
        </form>
    </div>
</div>
<div class="card">
    <div class="card-body">
        <ul class="list-group list-group-flush" id="activity-list">
            {% for activity in customer.activity_set.all|dictsortreversed:"activity_date" %}
                <li class="list-group-item">
                    <strong>{{ activity.activity_date }}</strong>
                    <span class="badge bg-secondary ms-2">{{ activity.get_status_display}}</span>
                    <br>
                    {{ activity.note | linebreakesbr }}
                </li>
            {% empty %}
                 <li class="list-group-item text-muted" id="no-activity-msg">商談履歴はありません</li>
                 {% endfor %}
        </ur>
    </div>
</div>

<script>
    document.getElementById('activity-form').addEventListener('submit', function(e) {
        e.preventDefault(); //1.画面遷移（本来の送信）を止める
        
        const form = this;
        const formDate = new FormData(form); // フォームのデータを自動収集
        const url = "{% url 'ajax_add_activity' %}"; //送信先URL

        // 2. Fetch APIで非同期通信
        fetch(url, {
            method: 'POST',
            body: formDate,
            headers: {
                'X-Requested-With': 'XMLHttpRequest' //DjangoにAjaxだと認識させるおまじない
            }
        })
        .then(Response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json(); // レスポンスをJSONとしてパース
        })
        .then(data => {
            //3.　成功時の処理

            // 「ありません」とメッセージが
            const noMsg = document.getElementById('no-activity-msg');
            if(noMsg)noMsg.remove();

            //新しい
            const list = document.getElementById('activity-list');
            const newItem = document.createElement('li');
            newItem.className = 'list-group-item bg-info bg-opacity-10'; //追加されたことが、、、
            newItem.innerHTML = `
                <strong>${data.activity_date}</strong>
                <span class = "badge bg-secondary ms-2">${data.status}</span>
                <br>
                ${data.note}
            `;

                //リストの先頭に
                list.prepend(newItem);

                //フォームを空にする
                form.reset()
        })
        .catch(error => {
            console.error('Error:'', error);
            alert('エラーが発生しました。');
        };
    });
</script>
{% endblock %} -->

<div class="d-flex justify-content-between align-items-center mb-3">
    <h1>{{ customer.company_name }}</h1>    
    <div>
        <a href="{% url 'customer_update' customer.pk %}" class="btn btn-secondary">[　編集する　]</a>
        <button type="button" class="btn btn-danger" data-bs-toggle="modal" data-bs-target="#deleteConfirmModal">[　削除する　]</button>
    </div>
</div>
<div class="card">
    <div class="card-body">
        <p><strong>担当者名:</strong> {{ customer.contact_name }}</p>
        <p><strong>メール:</strong> {{ customer.email }}</p>
    </div>
</div>
        <!-- <p><strong>電話番号:</strong> {{ customer.phone | default:"-" }}</p>
        <p><strong>担当営業:</strong> {{ customer.user | default:"未割り当て" }}</p>
        <p><strong>タグ:</strong></p>           -->
        
<h3 class="mt-4">商談履歴</h3>
<div class="card">
    <div class="card-body">
    </div>
</div>
<hr>
<a href="{% url 'customer_list' %}" class="btn btn-outline-primary ">一覧に戻る</a>
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-labelledby="deleteModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="deleteModalLabel">削除の確認</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    本当に　{{ customer.company_name}}を削除しますか？<br>この操作は元に戻せません。
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">キャンセル</button>
                    <form action="{% url 'customer_delete' customer.pk %}" method="POST" style="display: inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger">はい、削除します</button>
                    </form>
                </div>
            </div>
        </div>
</div>




<h3 class="mt-4">商談履歴</h3>

    <div class="card mb-3 bg-light">
        <div class="card-body">
            <h6 class="card-title">商談をクイック追加</h6>
            <form id="activity-form">
                {% csrf_token %}
                <input type="hidden" name="customer_id" value="{{ customer.pk }}">

                <div class="row g-2">
                    <div class="col-md-3">
                        <input type="date" name="activity_date" class="form-control" required>
                    </div>
                    <div class="col-md-3">
                        <select name="status" class="form-select" required> 
                            <option value="APPO">アポ</option>
                            <option value="MEETING">商談中</option>
                            <option value="PROPOSAL">提案中</option>
                            <option value="WON">受注</option>
                            <option value="LOST">失注</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <input type="text" name="note" class="form-control" placeholder="メモを入力" required>
                    </div>
                    <div class="col-md-2">
                        <button type="submit" class="btn btn-primary w-100">追加</button>
                    </div>
                </div>
            </form>
        </div>
    </div>

    <div class="card">
        <div class="card-body">
            <ul class="list-group list-group-flush" id="activity-list">
                {% for activity in customer.activity_set.all %}
                    <li class="list-group-item">
                        <strong>{{ activity.activity_date }}</strong>
                        <span class="badge bg-secondary ms-2">{{ activity.get_status_display}}</span>
                        <br>
                        {{ activity.note | linebreaksbr }}
                    </li>
                {% empty %}
                     <li class="list-group-item text-muted" id="no-activity-msg">商談履歴はありません</li>
                {% endfor %}
            </ul>
        </div>
    </div>

    <hr>
    <a href="{% url 'customer_list' %}" class="btn btn-outline-secondary">一覧に戻る</a>

    {# 削除確認モーダル（省略） #}

    <script>
        document.getElementById('activity-form').addEventListener('submit', function(e) {
            e.preventDefault(); // 1.画面遷移（本来の送信）を止める
            
            const form = this;
            const formData = new FormData(form); // フォームのデータを自動収集
            
            // 修正: URLを動的に生成し、顧客ID (pk) をURLに含める
            const customerPk = document.querySelector('input[name="customer_id"]').value;
            const url = "{% url 'activity_create_ajax' 0 %}".replace('/0/', '/' + customerPk + '/');

            // CSRFトークンを取得
            const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;

            // 2. Fetch APIで非同期通信
            fetch(url, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': csrftoken, // CSRFトークンをヘッダーに追加
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => {
                if (!response.ok) {
                    return response.json().then(errorData => {
                        alert(errorData.message || '入力エラー');
                        throw new Error('入力エラー');
                    });
                }
                return response.json(); // レスポンスをJSONとしてパース
            })
            .then(data => {
                // 3. 成功時の処理

                // 「商談履歴はありません」というメッセージを削除
                const noMsg = document.getElementById('no-activity-msg');
                if(noMsg) noMsg.remove();

                // 新しい要素を生成 (バッククォート `` で複数行文字列を作成)
                const list = document.getElementById('activity-list');
                const newItem = document.createElement('li');
                newItem.className = 'list-group-item bg-info bg-opacity-10'; // 追加されたことがわかる色に

                // HTMLタグをバッククォートで生成し、JS変数を埋め込む
                newItem.innerHTML = `
                    <strong>${data.activity_date}</strong>
                    <span class="badge bg-secondary ms-2">${data.status}</span>
                    <br>
                    ${data.note}
                `;
                
                // リストの先頭に追加
                list.prepend(newItem);

                // フォームを空にする
                form.reset(); 
                
                alert('商談履歴が追加されました！'); // 成功通知
            })
            .catch(error => {
                console.error('Error:', error);
                alert('エラーが発生しました: ' + error.message);
            });
        });
    </script>
{% endblock %}